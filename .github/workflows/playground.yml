name: run

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  kustomize:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        overlay:
          - "dev"
    steps:
      - name: "Checkout cos-manifests project"
        uses: actions/checkout@v2
        with:
          repository: bf2fc6cc711aee1a0c2a/cos-manifests
      - name: "Update Kustomize overlay ${{ matrix.overlay }}"
        uses: mikefarah/yq@master
        env:
          OVERLAY_PATH: kustomize/overlays/${{ matrix.overlay }}
          NEW_TAG: main-${{ github.sha }}
        with:
          cmd: |
            yq -i ".images[0].newTag = env(NEW_TAG)" ${OVERLAY_PATH}/kustomization.yaml
            yq -i ".images[1].newTag = env(NEW_TAG)" ${OVERLAY_PATH}/kustomization.yaml
            yq -i ".images[2].newTag = env(NEW_TAG)" ${OVERLAY_PATH}/kustomization.yaml

      - name: "Create PR for ${{ matrix.overlay }}"
        env:
          OVERLAY_PATH: kustomize/overlays/${{ matrix.overlay }}
          BRANCH_NAME: "overlay.${{ matrix.overlay }}.${{ github.sha }}"
          NEW_TAG: main-${{ github.sha }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo ""
          echo "tag     : $NEW_TAG"
          echo "branch  : $BRANCH_NAME"
          echo ""

          cat ${OVERLAY_PATH}/kustomization.yaml

          git config user.email lburgazzoli@gmail.com
          git config user.name lburgazzoli

          git checkout -b ${BRANCH_NAME}
          git add ${OVERLAY_PATH}
          git commit -m "Update kustomization images for overlay ${{ matrix.overlay }}" ${OVERLAY_PATH}
          git reset --hard
          git push -u origin ${BRANCH_NAME}

          # GH CLI can't find the branch on remote... needs some time :)
          sleep 15

          gh config set prompt disabled

          gh pr create \
            --fill \
            --draft \
            --base main \
            --title "chore(kustomize): update kustomization images overlay ${{ matrix.overlay }}" \
            --body "sha ${{ github.sha }}, overlay ${{ matrix.overlay }}, tag: ${NEW_TAG}"
